<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>防治率計算器</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #111827;
      color: #f3f4f6;
      margin: 0;
      padding: 0;
    }
    .container {
      padding: 20px;
      max-width: 1200px;
      margin: auto;
    }
    h1, h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    .controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    th, td {
      border: 1px solid #374151;
      padding: 6px;
      text-align: center;
    }
    input[type="number"] {
      width: 70px;
      padding: 5px;
      background-color: #1f2937;
      border: 1px solid #374151;
      color: #f3f4f6;
    }
    button {
      background-color: #2563eb;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #1d4ed8;
    }
    #chartContainer {
      margin-top: 40px;
    }
    canvas {
      background: #1f2937;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
  </style>
</head>
<body>
<div class="container">
  <h1>防治率計算器</h1>
  <div class="controls">
    <label>處理組數量: <input type="number" id="treatments" value="3" min="1"></label>
    <label>重複數: <input type="number" id="replicates" value="3" min="1"></label>
    <label>時間點數: <input type="number" id="timepoints" value="12" min="1"></label>
    <button id="generate">產生輸入表格</button>
  </div>
  <div id="tableContainer"></div>
  <div class="controls">
    <button id="fillDemo">填入示範資料</button>
    <button id="calculate">計算防治率 & 繪圖</button>
  </div>
  <div id="results"></div>
  <div id="chartContainer">
    <h2>年度防治率折線圖</h2>
    <canvas id="chart" width="1000" height="400"></canvas>
  </div>
</div>

<script>
function generateTable() {
  const t = parseInt(document.getElementById('treatments').value);
  const r = parseInt(document.getElementById('replicates').value);
  const tp = parseInt(document.getElementById('timepoints').value);
  const container = document.getElementById('tableContainer');
  container.innerHTML = '';
  let html = '<table><tr><th>時間點</th>';
  for (let i = 1; i <= r; i++) html += `<th>對照-重複${i}</th>`;
  for (let j = 1; j <= t; j++) {
    for (let i = 1; i <= r; i++) {
      html += `<th>處理${j}-重複${i}</th>`;
    }
  }
  html += '</tr>';
  for (let time = 1; time <= tp; time++) {
    html += `<tr><td>${time}</td>`;
    for (let i = 1; i <= r; i++) html += `<td><input type="number" id="ctrl_${time}_${i}" min="0"></td>`;
    for (let j = 1; j <= t; j++) {
      for (let i = 1; i <= r; i++) {
        html += `<td><input type="number" id="trt${j}_${time}_${i}" min="0"></td>`;
      }
    }
    html += '</tr>';
  }
  html += '</table>';
  container.innerHTML = html;
}

function calculate() {
  const t = parseInt(document.getElementById('treatments').value);
  const r = parseInt(document.getElementById('replicates').value);
  const tp = parseInt(document.getElementById('timepoints').value);
  let datasets = [];
  let labels = Array.from({length: tp}, (_,i)=>`時間${i+1}`);
  
  for (let j = 1; j <= t; j++) {
    let data = [];
    for (let time = 1; time <= tp; time++) {
      let ctrlVals = [];
      for (let i = 1; i <= r; i++) {
        let val = parseFloat(document.getElementById(`ctrl_${time}_${i}`).value)||0;
        ctrlVals.push(Math.sqrt(val+0.5));
      }
      let ctrlMean = ctrlVals.reduce((a,b)=>a+b,0)/r;

      let trtVals = [];
      for (let i = 1; i <= r; i++) {
        let val = parseFloat(document.getElementById(`trt${j}_${time}_${i}`).value)||0;
        trtVals.push(Math.sqrt(val+0.5));
      }
      let trtMean = trtVals.reduce((a,b)=>a+b,0)/r;

      if (ctrlMean === 0) {
        data.push(null);
      } else {
        let eff = (1 - trtMean/ctrlMean) * 100;
        data.push(eff);
      }
    }
    datasets.push({label: `處理${j}`, data: data, borderWidth:2, fill:false});
  }

  drawChart(labels, datasets);
}

function drawChart(labels, datasets) {
  const ctx = document.getElementById('chart').getContext('2d');
  if (window.myChart) window.myChart.destroy();
  window.myChart = new Chart(ctx, {
    type: 'line',
    data: { labels: labels, datasets: datasets },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero:true, title:{display:true,text:'防治率 (%)'} },
        x: { title:{display:true,text:'時間'} }
      }
    }
  });
}

function fillDemo() {
  const inputs = document.querySelectorAll('input[type=number]');
  inputs.forEach(inp=>inp.value = Math.floor(Math.random()*30+10));
}

// 綁定事件
 document.getElementById('generate').addEventListener('click', generateTable);
 document.getElementById('calculate').addEventListener('click', calculate);
 document.getElementById('fillDemo').addEventListener('click', fillDemo);

// 預設生成表格
generateTable();
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</body>
</html>
