<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>防治率計算器｜多處理 × 重複 × 年度折線圖</title>
  <style>
    :root {
      --bg: #0f172a; /* slate-900 */
      --panel: #111827; /* gray-900 */
      --panel-2: #0b1220;
      --text: #e5e7eb; /* gray-200 */
      --muted: #9ca3af; /* gray-400 */
      --accent: #22c55e; /* green-500 */
      --border: #1f2937; /* gray-800 */
      /* Ghost button colors for dark mode */
      --ghost-color: var(--text);
      --ghost-border: var(--border);
      --ghost-hover-border: #334155;
    }
    body.light-mode {
      --bg: #f8fafc;
      --panel: #ffffff;
      --panel-2: #f1f5f9;
      --text: #1f2937;
      --muted: #6b7280;
      --accent: #16a34a;
      --border: #e2e8f0;
      /* Ghost button colors for light mode */
      --ghost-color: var(--muted);
      --ghost-border: #cbd5e1;
      --ghost-hover-border: #94a3b8;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; background: linear-gradient(180deg, var(--bg), #060a14 60%);
      color: var(--text); font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial,
      "Noto Sans", "Liberation Sans", sans-serif; line-height: 1.5;
    }
    body.light-mode { background: #f1f5f9; }
    header { padding: 20px 24px; border-bottom: 1px solid var(--border); position: sticky; top:0; background: rgba(15,23,42,.85); backdrop-filter: blur(6px); display: flex; align-items: center; justify-content: space-between;}
    body.light-mode header { background: rgba(255,255,255,.85); }
    h1 { margin: 0; font-size: 20px; letter-spacing: .5px; }
    main { padding: 20px 24px 80px; max-width: 1200px; margin: 0 auto; }

    .row { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
    .card { background: linear-gradient(180deg, var(--panel), var(--panel-2)); border: 1px solid var(--border); border-radius: 16px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.25);
      margin-bottom: 16px; }
    body.light-mode .card { box-shadow: 0 4px 12px rgba(0,0,0,.08); }
    label { font-size: 13px; color: var(--muted); }
    input[type="number"], input[type="text"] { background: var(--panel-2); color: var(--text); border: 1px solid var(--border); border-radius: 10px; padding: 8px 10px; width: 110px; }
    input[type="number"]::-webkit-outer-spin-button,input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }

    button { background: #1f2937; border: 1px solid var(--border); color: var(--text); padding: 10px 14px; border-radius: 12px; cursor: pointer; transition: .15s ease; }
    button:hover { transform: translateY(-1px); border-color: #334155; }
    button.primary { background: var(--accent); color: #06290f; border-color: #16a34a; font-weight: 600; }
    button.ghost { background: transparent; color: var(--ghost-color); border-color: var(--ghost-border); }
    button.ghost:hover { border-color: var(--ghost-hover-border); }
    button.ghost:active { transform: translateY(0); } /* Added for better UI feel */

    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { border: 1px solid var(--border); padding: 6px 8px; text-align: center; }
    th { background: var(--panel-2); position: sticky; top: 0; z-index: 1; }
    body.light-mode th { background: #e2e8f0; }
    .treatment-group { background: #1c273a; }
    body.light-mode .treatment-group { background: #eff6ff; }
    .treatment-group:nth-child(even) { background: #16202f; }
    body.light-mode .treatment-group:nth-child(even) { background: #e2e8f0; }

    .muted { color: var(--muted); }
    .note { font-size: 12px; color: var(--muted); margin-top: 6px; }
    .badge { font-size: 12px; color: #0b1324; background: #86efac; padding: 2px 8px; border-radius: 999px; margin-left: 8px; }
    body.light-mode .badge { background: #bbf7d0; }

    .legend { display: flex; flex-wrap: wrap; gap: 8px 12px; align-items: center; margin-top: 8px; }
    .legend-item { display: inline-flex; align-items: center; gap: 6px; font-size: 12px; color: var(--muted); }
    .swatch { width: 14px; height: 14px; border-radius: 3px; }

    canvas { width: 100%; height: 420px; background: var(--panel-2); border: 1px solid var(--border); border-radius: 16px; }
    .scroll-x { overflow-x: auto; }
    .sticky-actions { position: sticky; bottom: 0; background: rgba(11,18,32,.9); backdrop-filter: blur(6px); padding: 10px; display:flex; gap:8px; border:1px solid var(--border); border-radius:12px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="light-mode">
  <header>
    <h1>防治率計算器 <span class="badge">(X+0.5)½ 轉換 + 折線圖</span></h1>
    <button id="themeToggle" class="ghost" style="padding: 6px 10px;">切換主題</button>
  </header>
  <main>
    <section class="card">
      <div class="row" style="gap:16px">
        <div>
          <label>處理組數量</label><br>
          <input id="treatments" type="number" min="1" value="3">
        </div>
        <div>
          <label>重複數（含對照）</label><br>
          <input id="replicates" type="number" min="1" value="3">
        </div>
        <div>
          <label>時間點數量（例如：月份）</label><br>
          <input id="timepoints" type="number" min="1" value="12">
        </div>
        <div>
          <label>時間點前綴（可空白）</label><br>
          <input id="tpPrefix" type="text" placeholder="例：月">
        </div>
        <div class="row">
          <button id="btnBuild" class="primary">產生輸入表格</button>
          <button id="btnDemo">填入示範資料</button>
          <button id="btnCalc">計算防治率 & 繪圖</button>
          <button id="btnImport" class="ghost">匯入 CSV</button>
          <button id="btnCSV" class="ghost">匯出 CSV</button>
          <button id="btnPNG" class="ghost">下載圖表 PNG</button>
          <input type="file" id="fileInput" accept=".csv" style="display:none;">
        </div>
      </div>
      <div id="treatmentNames" style="margin-top:12px"></div>
      <p class="note">轉換：<code>(X + 0.5)<sup>1/2</sup></code>；防治率（%）＝ <code>(1 − 平均處理區(轉換後) / 平均對照區(轉換後)) × 100</code>。若對照平均為 0（轉換後）則該時間點無法計算，會以 <code>—</code> 顯示並在圖上略過。</p>
    </section>

    <section class="card">
      <h3 style="margin:0 0 8px">輸入資料</h3>
      <div id="tableHost" class="scroll-x"></div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 8px">計算結果</h3>
      <div id="resultHost" class="scroll-x"></div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 8px">年度防治率折線圖</h3>
      <canvas id="chartCanvas"></canvas>
    </section>
  </main>

  <script>
    // ====== 公用函式 ======
    const $ = (sel) => document.querySelector(sel);
    const trans = (x) => Math.sqrt((Number(x) || 0) + 0.5); // (X+0.5)^{1/2}
    const mean = (arr) => arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : NaN;
    const round2 = (v) => (isFinite(v) ? Math.round(v * 100) / 100 : v);

    // 色板（最多 12 組處理）
    function colorFor(i) {
        const colors = ['#22c55e', '#ef4444', '#3b82f6', '#f97316', '#a855f7', '#14b8a6', '#f59e0b', '#d946ef', '#6366f1', '#ec4899', '#84cc16', '#6b7280'];
        const lightColors = ['#22c55e', '#ef4444', '#3b82f6', '#f97316', '#a855f7', '#14b8a6', '#f59e0b', '#d946ef', '#6366f1', '#ec4899', '#84cc16', '#6b7280'];
        const theme = $('body').classList.contains('light-mode') ? 'light' : 'dark';
        if (theme === 'light') return lightColors[i % lightColors.length];
        return colors[i % colors.length];
    }
    
    // ====== 動態建立輸入表格與處理組名稱 ======
    function buildInputs() {
        buildTreatmentNames();
        buildTable();
    }

    function buildTreatmentNames() {
        const T = parseInt($('#treatments').value) || 1;
        const host = $('#treatmentNames');
        let html = '<div class="row" style="gap:16px"><p style="font-size:13px;color:var(--muted);margin:0;align-self:flex-end;white-space:nowrap">處理組名稱：</p>';
        for (let t = 1; t <= T; t++) {
            html += `<div><label>處理${t}</label><br><input type="text" id="tName_${t}" value="處理${t}" style="width:100px"/></div>`;
        }
        html += '</div>';
        host.innerHTML = html;
    }

    function getTreatmentNames() {
        const T = parseInt($('#treatments').value) || 1;
        const names = [];
        for (let t = 1; t <= T; t++) {
            names.push($(`#tName_${t}`).value || `處理${t}`);
        }
        return names;
    }

    function buildTable() {
        const T = parseInt($('#treatments').value) || 1;
        const R = parseInt($('#replicates').value) || 1;
        const N = parseInt($('#timepoints').value) || 1;
        const prefix = ($('#tpPrefix').value || '').trim();
        const names = getTreatmentNames();

        let html = '<div class="note" style="margin-bottom:6px">每個時間點皆需填入 <b>對照</b>與<b>各處理</b>的<b>重複</b>蟲數（未轉換原始值）。</div>';
        html += '<table><thead><tr><th>時間點</th>';
        for (let r = 1; r <= R; r++) html += `<th class="control-group">對照-重複${r}</th>`;
        for (let t = 0; t < T; t++) {
            for (let r = 1; r <= R; r++) html += `<th class="treatment-group t-${t}"><span>${names[t]}</span>-重複${r}</th>`;
        }
        html += '</tr></thead><tbody>';
        for (let i = 1; i <= N; i++) {
            const label = prefix ? `${i}${prefix}` : `${i}`;
            html += `<tr data-row="${i}"><td>${label}</td>`;
            for (let r = 1; r <= R; r++) html += `<td class="control-group"><input type="text" id="ctrl_${i}_${r}" placeholder=""/></td>`;
            for (let t = 1; t <= T; t++) {
                for (let r = 1; r <= R; r++) html += `<td class="treatment-group"><input type="text" id="t${t}_${i}_${r}" placeholder=""/></td>`;
            }
            html += '</tr>';
        }
        html += '</tbody></table>';
        $('#tableHost').innerHTML = html;
        $('#resultHost').innerHTML = '';
        clearChart();
        setupTableNavigation();
    }

    // ====== 鍵盤導航功能 ======
    function setupTableNavigation() {
        const inputs = $('#tableHost').querySelectorAll('input');
        inputs.forEach((input, index) => {
            input.addEventListener('keydown', (e) => {
                const T = parseInt($('#treatments').value) || 1;
                const R = parseInt($('#replicates').value) || 1;
                const cols = (T * R) + R; // 總輸入欄位數
                const col = (index % cols);

                let nextIndex = index;
                if (e.key === 'ArrowRight' || (e.key === 'Tab' && !e.shiftKey)) {
                    e.preventDefault();
                    nextIndex = (index + 1) % inputs.length;
                } else if (e.key === 'ArrowLeft' || (e.key === 'Tab' && e.shiftKey)) {
                    e.preventDefault();
                    nextIndex = (index - 1 + inputs.length) % inputs.length;
                } else if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    nextIndex = (index + cols) % inputs.length;
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    nextIndex = (index - cols + inputs.length) % inputs.length;
                }
                inputs[nextIndex].focus();
            });
        });
    }

    // ====== 讀取輸入、計算、防治率表 ======
    function compute() {
        const T = parseInt($('#treatments').value) || 1;
        const R = parseInt($('#replicates').value) || 1;
        const N = parseInt($('#timepoints').value) || 1;
        const prefix = ($('#tpPrefix').value || '').trim();
        const names = getTreatmentNames();

        const labels = Array.from({ length: N }, (_, i) => prefix ? `${i + 1}${prefix}` : `${i + 1}`);

        // 轉換後的平均（對照、處理）
        const ctrlAvg = new Array(N).fill(NaN);
        const trAvg = Array.from({ length: T }, () => new Array(N).fill(NaN));

        for (let i = 1; i <= N; i++) {
            const ctrlVals = [];
            for (let r = 1; r <= R; r++) ctrlVals.push(trans($('#ctrl_' + i + '_' + r)?.value));
            ctrlAvg[i - 1] = mean(ctrlVals);
            for (let t = 1; t <= T; t++) {
                const vals = [];
                for (let r = 1; r <= R; r++) vals.push(trans($('#t' + t + '_' + i + '_' + r)?.value));
                trAvg[t - 1][i - 1] = mean(vals);
            }
        }

        // 防治率
        const eff = Array.from({ length: T }, () => new Array(N).fill(null));
        for (let t = 0; t < T; t++) {
            for (let i = 0; i < N; i++) {
                const c = ctrlAvg[i];
                const a = trAvg[t][i];
                if (!isFinite(c) || c <= 0) { eff[t][i] = null; continue; }
                eff[t][i] = round2((1 - a / c) * 100);
            }
        }

        // 結果表
        let html = '<div class="note" style="margin-bottom:6px">顯示的是以 <b>(X+0.5)½</b> 轉換後取平均，再代入公式所得之防治率（%）。</div>';
        html += '<table><thead><tr><th>時間點</th><th>對照平均(轉換後)</th>';
        for (let t = 0; t < T; t++) html += `<th>${names[t]} 防治率(%)</th>`;
        html += '</tr></thead><tbody>';
        for (let i = 0; i < N; i++) {
            html += `<tr><td>${labels[i]}</td><td>${isFinite(ctrlAvg[i]) ? round2(ctrlAvg[i]) : '—'}</td>`;
            for (let t = 0; t < T; t++) html += `<td>${eff[t][i] === null ? '—' : eff[t][i]}</td>`;
            html += '</tr>';
        }
        html += '</tbody></table>';
        $('#resultHost').innerHTML = html;

        // 繪圖
        const datasets = [];
        for (let t = 0; t < T; t++) {
            datasets.push({
                label: names[t],
                data: eff[t],
                borderColor: colorFor(t),
                tension: 0.2,
                pointRadius: 4,
                pointBackgroundColor: colorFor(t),
            });
        }
        drawChart(labels, datasets);

        // 給 CSV / 下載用暫存
        window.__calcCache = { labels, ctrlAvg, eff, datasets };
    }

    // ====== 匯出 CSV ======
    function exportCSV() {
        const cache = window.__calcCache;
        if (!cache) { alert('請先計算再匯出。'); return; }
        const { labels, ctrlAvg, datasets } = cache;
        const header = ['時間點', '對照平均(轉換後)', ...datasets.map(s => s.label + ' 防治率(%)')];
        const rows = [header];
        for (let i = 0; i < labels.length; i++) {
            rows.push([labels[i], round2(ctrlAvg[i])].concat(datasets.map(s => s.data[i] ?? '')));
        }
        const csv = rows.map(r => r.join(',')).join('\n');
        const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'control-efficacy.csv';
        a.click();
        URL.revokeObjectURL(a.href);
    }

    // ====== 匯入 CSV ======
    function importCSV(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(event) {
            const text = event.target.result;
            const lines = text.split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) { alert('CSV 格式錯誤，請確保檔案包含標題和至少一行數據。'); return; }

            const header = lines[0].split(',');
            const dataRows = lines.slice(1).map(line => line.split(','));

            const T = parseInt($('#treatments').value) || 1;
            const R = parseInt($('#replicates').value) || 1;
            const N = dataRows.length;

            $('#replicates').value = R;
            $('#timepoints').value = N;

            // Update treatment names
            const names = [];
            for (let t = 1; t <= T; t++) {
                const regex = new RegExp(`處理${t}-重複1`);
                const nameIndex = header.findIndex(h => regex.test(h));
                if (nameIndex !== -1) {
                    const name = header[nameIndex].split('-')[0];
                    names.push(name);
                } else {
                    names.push(`處理${t}`);
                }
            }
            buildTreatmentNames();
            names.forEach((name, i) => {
                if ($(`#tName_${i + 1}`)) $(`#tName_${i + 1}`).value = name;
            });
            
            buildTable();

            // Fill table with imported data
            const totalCols = R + (T * R) + 1;
            for (let i = 0; i < N; i++) {
                const rowData = dataRows[i];
                if (rowData.length < totalCols) continue;
                // Control group
                for (let r = 1; r <= R; r++) {
                    const input = $(`#ctrl_${i + 1}_${r}`);
                    if (input) input.value = rowData[r] || '';
                }
                // Treatment groups
                for (let t = 1; t <= T; t++) {
                    for (let r = 1; r <= R; r++) {
                        const input = $(`#t${t}_${i + 1}_${r}`);
                        const dataIndex = R + (t-1) * R + r;
                        if (input) input.value = rowData[dataIndex] || '';
                    }
                }
            }
        };
        reader.readAsText(file, 'UTF-8');
    }


    // ====== 下載 PNG ======
    function downloadPNG() {
        const a = document.createElement('a');
        a.href = chart.toBase64Image();
        a.download = 'efficacy-chart.png';
        a.click();
    }
    let chart;
    function clearChart() {
        if (chart) {
            chart.destroy();
        }
    }

    function drawChart(labels, datasets) {
        clearChart();
        const ctx = $('#chartCanvas').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { boxWidth: 15, color: 'var(--muted)' }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += round2(context.parsed.y) + '%';
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { color: 'var(--border)' },
                        ticks: { color: 'var(--muted)' },
                        title: { display: true, text: '時間點', color: 'var(--text)' }
                    },
                    y: {
                        grid: { color: 'var(--border)' },
                        ticks: { color: 'var(--muted)' },
                        title: { display: true, text: '防治率 (%)', color: 'var(--text)' },
                        min: 0,
                        max: 100
                    }
                }
            }
        });
    }

    // ====== 示範資料（產生可視化趨勢） ======
    function fillDemo() {
        if (!$('#tableHost').querySelector('table')) buildInputs();
        const T = parseInt($('#treatments').value) || 1;
        const R = parseInt($('#replicates').value) || 1;
        const N = parseInt($('#timepoints').value) || 1;
        for (let i = 1; i <= N; i++) {
            const baseCtrl = 24 + Math.round(6 * Math.sin(i / 2));
            for (let r = 1; r <= R; r++) $('#ctrl_' + i + '_' + r).value = Math.max(0, Math.round(baseCtrl + (Math.random() * 6 - 3)));
            for (let t = 1; t <= T; t++) {
                for (let r = 1; r <= R; r++) {
                    const drift = (t * 3) + (i * 0.6); // 隨時間與處理強度略增
                    const val = Math.max(0, Math.round(baseCtrl - drift + (Math.random() * 6 - 3)));
                    $('#t' + t + '_' + i + '_' + r).value = val;
                }
            }
        }
        compute();
    }

    // ====== 事件繫結 ======
    window.addEventListener('DOMContentLoaded', () => {
        $('#btnBuild').addEventListener('click', buildInputs);
        $('#btnDemo').addEventListener('click', fillDemo);
        $('#btnCalc').addEventListener('click', compute);
        $('#btnImport').addEventListener('click', () => $('#fileInput').click());
        $('#fileInput').addEventListener('change', importCSV);
        $('#btnCSV').addEventListener('click', exportCSV);
        $('#btnPNG').addEventListener('click', downloadPNG);

        $('#treatments').addEventListener('change', buildTreatmentNames);

        $('#themeToggle').addEventListener('click', () => {
            document.body.classList.toggle('light-mode');
            localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
            if (chart) {
                // Manually redraw chart to apply new colors
                chart.data.datasets.forEach((dataset, i) => {
                    dataset.borderColor = colorFor(i);
                    dataset.pointBackgroundColor = colorFor(i);
                });
                chart.options.scales.x.grid.color = 'var(--border)';
                chart.options.scales.x.ticks.color = 'var(--muted)';
                chart.options.scales.x.title.color = 'var(--text)';
                chart.options.scales.y.grid.color = 'var(--border)';
                chart.options.scales.y.ticks.color = 'var(--muted)';
                chart.options.scales.y.title.color = 'var(--text)';
                chart.options.plugins.legend.labels.color = 'var(--muted)';
                chart.update();
            }
        });

        // Check for saved theme preference
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.classList.remove('light-mode');
        } else {
            document.body.classList.add('light-mode');
        }

        // 預設先建一份表格以免使用者看不到輸入區
        buildInputs();
    });
  </script>
</body>
</html>
